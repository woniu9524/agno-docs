---
title: 使用 Storage 实现持久化状态
---
本示例演示了如何使用 SQLite 存储来持久化 Agent 的会话状态，从而实现在多次运行之间的连续性。
## 代码

```python cookbook/agent_concepts/state/session_state_storage.py

from agno.agent import Agent
from agno.models.openai import OpenAIChat
from agno.storage.sqlite import SqliteStorage


# 定义一个将项目添加到购物列表的工具
def add_item(agent: Agent, item: str) -> str:
    """将项目添加到购物列表。"""
    if item not in agent.session_state["shopping_list"]:
        agent.session_state["shopping_list"].append(item)
    return f"购物列表现在是 {agent.session_state['shopping_list']}"


agent = Agent(
    model=OpenAIChat(id="gpt-4o-mini"),
    # 固定会话 ID 以在执行周期之间继续相同的会话
    session_id="fixed_id_for_demo",
    # 使用空的购物列表初始化会话状态
    session_state={"shopping_list": []},
    # 添加一个将项目添加到购物列表的工具
    tools=[add_item],
    # 将会话状态存储在 SQLite 数据库中
    storage=SqliteStorage(table_name="agent_sessions", db_file="tmp/data.db"),
    # 在指令中添加当前的购物列表状态
    instructions="Current shopping list is: {shopping_list}",
    # 重要提示：设置 `add_state_in_messages=True`
    # 以便在指令中可用 `{shopping_list}`
    add_state_in_messages=True,
    markdown=True,
)

# 示例用法
agent.print_response("What's on my shopping list?", stream=True)
print(f"Session state: {agent.session_state}")
agent.print_response("Add milk, eggs, and bread", stream=True)
print(f"Session state: {agent.session_state}")
```

## 使用方法

<Steps>
  <Snippet file="create-venv-step.mdx" />

  <Step title="设置你的 API 密钥">
    ```bash
    export OPENAI_API_KEY=xxx
    ```
  </Step>

  <Step title="安装库">
    ```bash
    pip install -U openai agno
    ```
  </Step>

  <Step title="运行示例">
    <CodeGroup>
    ```bash Mac
    python cookbook/agent_concepts/state/session_state_storage.py
    ```

    ```bash Windows
    python cookbook/agent_concepts/state/session_state_storage.py
    ```
    </CodeGroup>
  </Step>
</Steps>