---
title: 用户记忆
---

当我们谈论记忆时，通常的理解是指存储智能体交互过程中关于用户见解和事实信息的能力。简而言之，就是为用户建立一个画像，了解他们的偏好，并利用这些信息来个性化智能体的响应。

## 智能体记忆 (Agentic Memory)

Agno Agents 原生支持智能体记忆管理，并推荐将其作为您记忆探索的起点。

通过智能体记忆，智能体本身会创建、更新和删除用户对话中的记忆。

设置 `enable_agentic_memory=True` 来为智能体提供一个管理用户记忆的工具，该工具会将任务传递给 `MemoryManager` 类。

> 您也可以设置 `enable_user_memories=True`，这将总是在每次用户消息后运行 `MemoryManager`。[请参阅下方示例。](#after-each-run)

```python agentic_memory.py
from agno.agent import Agent
from agno.memory.v2.db.sqlite import SqliteMemoryDb
from agno.memory.v2.memory import Memory
from agno.models.openai import OpenAIChat
from agno.storage.sqlite import SqliteStorage
from rich.pretty import pprint

# 用户 ID，用于存储记忆
user_id = "ava"
# 用于记忆和存储的数据库文件
db_file = "tmp/agent.db"

# 初始化 memory.v2
memory = Memory(
    # 使用任何模型来创建记忆
    model=OpenAIChat(id="gpt-4.1"),
    db=SqliteMemoryDb(table_name="user_memories", db_file=db_file),
)
# 初始化存储
storage = SqliteStorage(table_name="agent_sessions", db_file=db_file)

# 初始化 Agent
memory_agent = Agent(
    model=OpenAIChat(id="gpt-4.1"),
    # 将记忆存储在数据库中
    memory=memory,
    # 赋予 Agent 更新记忆的能力
    enable_agentic_memory=True,
    # 或者 - 在每次响应后运行 MemoryManager
    enable_user_memories=True,
    # 将聊天记录存储在数据库中
    storage=storage,
    # 将聊天记录添加到消息中
    add_history_to_messages=True,
    # 历史记录运行次数
    num_history_runs=3,
    markdown=True,
)

memory.clear()
memory_agent.print_response(
    "My name is Ava and I like to ski.",
    user_id=user_id,
    stream=True,
    stream_intermediate_steps=True,
)
print("Memories about Ava:")
pprint(memory.get_user_memories(user_id=user_id))

memory_agent.print_response(
    "I live in san francisco, where should i move within a 4 hour drive?",
    user_id=user_id,
    stream=True,
    stream_intermediate_steps=True,
)
print("Memories about Ava:")
pprint(memory.get_user_memories(user_id=user_id))
```

- `add_history_to_messages=True` 会将聊天记录添加到发送给模型的消息中，`num_history_runs` 决定了添加多少次运行的记录。
- `read_chat_history=True` 会向 Agent 添加一个允许其读取聊天记录的工具，因为聊天记录可能比 `num_history_runs` 包含的内容要多。

## 每次运行后创建记忆

虽然 `enable_agentic_memory=True` 赋予了 Agent 管理用户记忆的工具，但我们也可以在每次用户消息后“触发” `MemoryManagement`。

设置 `enable_user_memories=True` 将在每次用户消息后始终处理记忆。

```python create_memories_after_each_run.py
from agno.agent.agent import Agent
from agno.memory.v2.db.sqlite import SqliteMemoryDb
from agno.memory.v2.memory import Memory
from agno.models.openai import OpenAIChat
from rich.pretty import pprint

memory_db = SqliteMemoryDb(table_name="memory", db_file="tmp/memory.db")
# 无需设置模型，它将设置为 Agent 的模型
memory = Memory(db=memory_db, delete_memories=True, clear_memories=True)

# 重置此示例的记忆
memory.clear()

# John Doe 的用户 ID
john_doe_id = "john_doe@example.com"
agent = Agent(
    model=OpenAIChat(id="gpt-4o-mini"),
    memory=memory,
    # 这将触发每次用户消息后的 MemoryManager
    enable_user_memories=True,
)

# 向 Agent 发送一条需要使用记忆的消息
agent.print_response(
    "My name is John Doe and I like to hike in the mountains on weekends.",
    stream=True,
    user_id=john_doe_id,
)

# 发送一条消息给 Agent 来检查记忆是否正常工作
agent.print_response("What are my hobbies?", stream=True, user_id=john_doe_id)

# 打印用户记忆
memories = memory.get_user_memories(user_id=john_doe_id)
print("Memories about John Doe:")
pprint(memories)

# 发送一条消息给 Agent 来移除该用户的全部记忆
agent.print_response(
    "Remove all existing memories of me.",
    stream=True,
    user_id=john_doe_id,
)
memories = memory.get_user_memories(user_id=john_doe_id)
print("Memories about John Doe:")
pprint(memories)
```

## 记忆管理

Agno 中的 `Memory` 类允许您管理用户记忆的各个方面。我们先从在 Agents 之外使用 `Memory` 的一些示例开始。我们将：

- 添加、更新和删除记忆
- 将记忆存储在数据库中
- 从对话中创建记忆
- 搜索记忆

```python
from agno.memory.v2.memory import Memory
from agno.memory.v2.db.sqlite import SqliteMemoryDb

# 创建一个带有持久化存储的记忆实例
memory_db = SqliteMemoryDb(table_name="memory", db_file="memory.db")
memory = Memory(db=memory_db)
```

### 添加新记忆

```python
from agno.memory.v2.memory import Memory
from agno.memory.v2.schema import UserMemory

memory = Memory()

# 手动创建用户记忆
memory_id = memory.add_user_memory(
    memory=UserMemory(
        memory="The user's name is Jane Doe",
        topics=["personal", "name"]
    ),
    user_id="jane_doe@example.com"
)
```

### 更新记忆

```python
from agno.memory.v2.memory import Memory
from agno.memory.v2.schema import UserMemory

memory = Memory()

# 替换用户记忆
memory_id = memory.replace_user_memory(
    # 要替换的记忆的 ID
    memory_id=previous_memory_id,
    # 用于替换的新记忆
    memory=UserMemory(
        memory="The user's name is Verna Doe",
        topics=["personal", "name"]
    ),
    user_id="jane_doe@example.com"
)
```

### 删除记忆

```python
from agno.memory.v2.memory import Memory

memory = Memory()

# 删除用户记忆
memory.delete_user_memory(user_id="jane_doe@example.com", memory_id=memory_id)
```

### 从用户信息创建记忆

```python
from agno.memory.v2 import Memory
from agno.memory.v2.db.sqlite import SqliteMemoryDb
from agno.models.google import Gemini

memory_db = SqliteMemoryDb(table_name="memory", db_file="tmp/memory.db")
memory = Memory(model=Gemini(id="gemini-2.0-flash-exp"), db=memory_db)

john_doe_id = "john_doe@example.com"

memory.create_user_memories(
    message="""
    I enjoy hiking in the mountains on weekends,
    reading science fiction novels before bed,
    cooking new recipes from different cultures,
    playing chess with friends,
    and attending live music concerts whenever possible.
    Photography has become a recent passion of mine, especially capturing landscapes and street scenes.
    I also like to meditate in the mornings and practice yoga to stay centered.
    """,
    user_id=john_doe_id,
)


memories = memory.get_user_memories(user_id=john_doe_id)
print("John Doe's memories:")
for i, m in enumerate(memories):
    print(f"{i}: {m.memory} - {m.topics}")
```

### 从对话创建记忆

```python
from agno.memory.v2 import Memory
from agno.memory.v2.db.sqlite import SqliteMemoryDb
from agno.models.google import Gemini
from agno.models.message import Message

memory_db = SqliteMemoryDb(table_name="memory", db_file="tmp/memory.db")
memory = Memory(model=Gemini(id="gemini-2.0-flash-exp"), db=memory_db)


jane_doe_id = "jane_doe@example.com"
# 发送消息历史并添加记忆
memory.create_user_memories(
    messages=[
        Message(role="user", content="My name is Jane Doe"),
        Message(role="assistant", content="That is great!"),
        Message(role="user", content="I like to play chess"),
        Message(role="assistant", content="That is great!"),
    ],
    user_id=jane_doe_id,
)

memories = memory.get_user_memories(user_id=jane_doe_id)
print("Jane Doe's memories:")
for i, m in enumerate(memories):
    print(f"{i}: {m.memory} - {m.topics}")
```

## 记忆搜索

Agno 提供了多种检索方法来搜索和检索用户记忆：

### 基本检索方法

您可以使用按时间顺序排列的方法来检索记忆，例如 `last_n`（最近的）或 `first_n`（最早的）：

```python
from agno.memory.v2 import Memory, UserMemory

memory = Memory()

john_doe_id = "john_doe@example.com"

memory.add_user_memory(
    memory=UserMemory(memory="The user enjoys hiking in the mountains on weekends"),
    user_id=john_doe_id,
)
memory.add_user_memory(
    memory=UserMemory(
        memory="The user enjoys reading science fiction novels before bed"
    ),
    user_id=john_doe_id,
)

# 获取最近的记忆
memories = memory.search_user_memories(
    user_id=john_doe_id, limit=1, retrieval_method="last_n"
)
print("John Doe's last_n memories:")
for i, m in enumerate(memories):
    print(f"{i}: {m.memory}")

# 获取最早的记忆
memories = memory.search_user_memories(
    user_id=john_doe_id, limit=1, retrieval_method="first_n"
)
print("John Doe's first_n memories:")
for i, m in enumerate(memories):
    print(f"{i}: {m.memory}")
```

### 智能体记忆搜索

智能体搜索允许您根据含义而不是精确的关键字匹配来查找记忆。这对于检索上下文相关的非常有用：

```python
from agno.memory.v2.memory import Memory, UserMemory
from agno.models.google.gemini import Gemini

# 使用模型初始化记忆以进行智能体搜索
memory = Memory(model=Gemini(id="gemini-2.0-flash-exp"))

john_doe_id = "john_doe@example.com"

memory.add_user_memory(
    memory=UserMemory(memory="The user enjoys hiking in the mountains on weekends"),
    user_id=john_doe_id,
)
memory.add_user_memory(
    memory=UserMemory(
        memory="The user enjoys reading science fiction novels before bed"
    ),
    user_id=john_doe_id,
)

# 搜索与查询相关的记忆
memories = memory.search_user_memories(
    user_id=john_doe_id,
    query="What does the user like to do on weekends?",
    retrieval_method="agentic",
)
print("John Doe's found memories:")
for i, m in enumerate(memories):
    print(f"{i}: {m.memory}")
```

通过智能体搜索，模型可以理解您查询背后的意图，并返回最相关的记忆，即使这些记忆不包含搜索中的确切关键字。

##开发者资源

- 在 [Cookbook](https://github.com/agno-agi/agno/tree/main/cookbook/agent_concepts/memory) 中查找完整示例
- 在[此处](/reference/memory/memory) 查看 `Memory` 类的类参考