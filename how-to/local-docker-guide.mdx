---
title: 运行本地 Agent API
---

本指南将带您了解：

- 使用 Agno agent 创建一个最小化的 FastAPI 应用
- 使用 Docker 对其进行容器化
- 本地运行，并使用 PostgreSQL 数据库进行知识和记忆存储

## 设置

<Steps>
  <Step title="为项目创建新目录">

创建一个新目录用于您的项目，并进入该目录。遵循本指南后，您的项目结构应如下所示：

    ```shell
    mkdir my-project
    cd my-project
    ```

遵循本指南后，您的项目结构应如下所示：

    ```shell
    my-project/
    ├── main.py
    ├── Dockerfile
    ├── requirements.txt
    ├── docker-compose.yml
    ```

  </Step>
  <Step title="创建 `requirements.txt` 文件并添加所需的依赖：">

```txt requirements.txt
fastapi
agno
openai
pgvector
pypdf
psycopg[binary]
sqlalchemy
uvicorn
```

  </Step>
</Steps>

## 步骤 1：创建带 Agno Agent 的 FastAPI 应用

<Steps>
  <Step title="创建一个新的 Python 文件，例如 `main.py`，并添加以下代码以创建一个带 Agno agent 的最小化 FastAPI 应用：">

```python main.py
from fastapi import FastAPI
from agno.agent import Agent
from agno.models.openai import OpenAIChat

app = FastAPI()

agent = Agent(
    model=OpenAIChat(id="gpt-4o"),
    description="You are a helpful assistant.",
    markdown=True,
)

@app.get("/ask")
async def ask(query: str):
    response = agent.run(query)
    return {"response": response.content}
```

  </Step>
  <Step title="创建并激活虚拟环境：">

```bash
python -m venv .venv
source .venv/bin/activate
```

  </Step>
  <Step title="通过运行以下命令安装所需的依赖：">

```bash
pip install -r requirements.txt
```

  </Step>
  <Step title="设置您的 OPENAI_API_KEY 环境变量：">

```bash
export OPENAI_API_KEY=your_api_key
```

  </Step>
  <Step title="使用 `uvicorn main:app --reload` 运行 FastAPI 应用。">

```bash
uvicorn main:app --reload
```

</Step>
</Steps>

## 步骤 2：创建 Dockerfile

<Steps>
  <Step title="在同一目录中，创建一个名为 `Dockerfile` 的新文件，并包含以下内容：">

```dockerfile Dockerfile
FROM agnohq/python:3.12

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

  </Step>
  <Step title="通过运行以下命令构建 Docker 镜像：">

```bash
docker build -t my-agent-app .
```

  </Step>
  <Step title="使用以下命令运行 Docker 容器：">

```bash
docker run -p 8000:8000 -e OPENAI_API_KEY=your_api_key my-agent-app
```

  </Step>
  <Step title="访问您的应用">

现在您可以在 `http://localhost:8000` 访问 FastAPI 应用。

  </Step>
</Steps>

## 步骤 3：使用 PostgreSQL 添加知识和记忆

<Steps>
  <Step title="更新您的 `main.py` 文件，以包含使用 PostgreSQL 的知识和记忆存储：">

```python main.py
from fastapi import FastAPI
from agno.agent import Agent
from agno.models.openai import OpenAIChat
from agno.knowledge.pdf_url import PDFUrlKnowledgeBase
from agno.vectordb.pgvector import PgVector
from agno.storage.postgres import PostgresStorage

app = FastAPI()

db_url = "postgresql+psycopg://agno:agno@db/agno"

knowledge_base = PDFUrlKnowledgeBase(
    urls=["https://agno-public.s3.amazonaws.com/recipes/ThaiRecipes.pdf"],
    vector_db=PgVector(table_name="recipes", db_url=db_url),
)
knowledge_base.load(recreate=True)

agent = Agent(
    model=OpenAIChat(id="gpt-4o"),
    description="You are a Thai cuisine expert!",
    knowledge=knowledge_base,
    storage=PostgresStorage(table_name="agent_sessions", db_url=db_url),
    markdown=True,
)

@app.get("/ask")
async def ask(query: str):
    response = agent.run(query)
    return {"response": response.content}
```

  </Step>
  <Step title="在同一目录中创建一个 `docker-compose.yml` 文件，并包含以下内容：">

```yaml docker-compose.yml
services:
  app:
    build: .
    ports:
      - "8000:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      db:
        condition: service_healthy

  db:
    image: agnohq/pgvector:16
    environment:
      POSTGRES_DB: agno
      POSTGRES_USER: agno
      POSTGRES_PASSWORD: agno
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U agno"]
      interval: 2s
      timeout: 5s
      retries: 5

volumes:
  pgdata:
```

  </Step>

  <Step title="使用以下命令运行 Docker Compose 设置：">

```bash
docker-compose up --build
```

这将启动 FastAPI 应用和 PostgreSQL 数据库，使您的 agent 能够使用知识和记忆存储。

现在您可以在 `http://localhost:8000` 访问 FastAPI 应用，并与已具备知识和记忆功能的 agent 进行交互。

您可以通过运行 `curl http://localhost:8000/ask?query="What is the recipe for pad thai?"` 来测试 agent。

</Step>
</Steps>